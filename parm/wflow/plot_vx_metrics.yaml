
default_task_test: &default_task
  account: '&ACCOUNT;'
  attrs:
    cycledefs: forecast
    maxtries: '2'
  envars: &default_vars
    GLOBAL_VAR_DEFNS_FP: '&GLOBAL_VAR_DEFNS_FP;'
    USHdir: '&USHdir;'
    EXPT_DIR: '{{workflow.EXPTDIR}}'
    HOMEdir: '&HOMEdir;'
    FCST_DIR: !cycstr '&FCST_DIR;'
    REFORMAT_YAML_CONFIG_NAME: '&HOMEdir;/parm/vx_plotting/config_files/reformat_ecnt.yaml' 
    REFORMAT_OUTPUT_BASE: '{{workflow.EXPTDIR}}/plot_vx_metrics'
    OUTPUT_ECNT_FILENAME: "ensemble_stat_ecnt.data"
    AGGREGATE_INPUT_BASE: '{{workflow.EXPTDIR}}/plot_vx_metrics'
    AGGREGATE_OUTPUT_BASE: '{{workflow.EXPTDIR}}/plot_vx_metrics'
    AGGREGATE_YAML_CONFIG_NAME: '&HOMEdir;/parm/vx_plotting/config_files/aggregate_ecnt.yaml' 
    STAT_INPUT_PLOT: '{{workflow.EXPTDIR}}/plot_vx_metrics'
    STAT_OUTPUT_PLOT: '{{workflow.EXPTDIR}}/plot_vx_metrics'
    PLOT_OUTPUT_FILENAME: 'ecnt_aggregated_{{verification.VX_FCST_VAR}}.png'
    PLOTTING_YAML_CONFIG_NAME: '&HOMEdir;/parm/vx_plotting/config_files/plot_spread_skill.yaml'
    VX_FCST_MODEL_NAME: '{{verification.VX_FCST_MODEL_NAME}} '
    VX_FCST_VAR: '{{verification.VX_FCST_VAR}}'
    INDY_VALS: '{{verification.INDY_VALS}}'
    VX_PLOTTING: '{{verification.VX_PLOTTING}}'
    DATE_LAST_CYCL: '{{workflow.DATE_LAST_CYCL}}'
    PDY: !cycstr "@Y@m@d"
    cyc: !cycstr "@H"
    subcyc: !cycstr "@M"
    LOGDIR: !cycstr "&LOGDIR;"
    SLASH_ENSMEM_SUBDIR: '&SLASH_ENSMEM_SUBDIR;'
    ENSMEM_INDX: '#mem#'
  native: '{{ platform.SCHED_NATIVE_CMD }}'
  nnodes: 1
  nodes: '{{ nnodes }}:ppn={{ ppn }}'
  partition: '{% if platform.get("PARTITION_DEFAULT") %}&PARTITION_DEFAULT;{% else %}None{% endif %}'
  ppn: 24
  queue: '&QUEUE_DEFAULT;'
  walltime: 00:05:00

task_run_reformat:
  <<: *default_task
  envars:
    <<: *default_vars
    OUTPUT_ECNT_FILENAME: !cycstr 'ensemble_stat_ecnt.data.@Y@m@d@H'
    REFORMAT_INPUT_BASE: !cycstr '&FCST_DIR;/metprd/EnsembleStat'
  command: '&LOAD_MODULES_RUN_TASK_FP; "vx_metrics" "&HOMEdir;/parm/vx_plotting/reformat_ecnt_linetype.py"'
  join: !cycstr '&LOGDIR;/reformat_@Y@m@d@H&LOGEXT;'
  dependency:
    and:
      or_APCP01h:
        not:
          taskvalid:
            attrs:
              task: run_MET_GridStat_vx_ensprob_APCP01h
        taskdep:
          attrs:
            task: run_MET_GridStat_vx_ensprob_APCP01h
      or_APCP03h:
        not:
          taskvalid:
            attrs:
              task: run_MET_GridStat_vx_ensprob_APCP03h
        taskdep:
          attrs:
            task: run_MET_GridStat_vx_ensprob_APCP03h
      or_APCP06h:
        not:
          taskvalid:
            attrs:
              task: run_MET_GridStat_vx_ensprob_APCP06h
        taskdep:
          attrs:
            task: run_MET_GridStat_vx_ensprob_APCP06h
      or_APCP24h:
        not:
          taskvalid:
            attrs:
              task: run_MET_GridStat_vx_ensprob_APCP24h
        taskdep:
          attrs:
            task: run_MET_GridStat_vx_ensprob_APCP24h
      or_ADPSFC:
        not:
          taskvalid:
            attrs:
              task: run_MET_GridStat_vx_ensprob_ADPSFC
        taskdep:
          attrs:
            task: run_MET_GridStat_vx_ensprob_ADPSFC
      or_ADPUPA:
        not:
          taskvalid:
            attrs:
              task: run_MET_GridStat_vx_ensprob_ADPUPA
        taskdep:
          attrs:
            task: run_MET_GridStat_vx_ensprob_ADPUPA

task_run_recombine:
  <<: *default_task
  command: rm -rf ${EXPT_DIR}/plot_vx_metrics/${OUTPUT_ECNT_FILENAME}; awk "NR == 1 || FNR > 1" ${EXPT_DIR}/plot_vx_metrics/${OUTPUT_ECNT_FILENAME}.* > ${EXPT_DIR}/plot_vx_metrics/${OUTPUT_ECNT_FILENAME}
  join: '&LOGDIR;/recombine&LOGEXT;'
  dependency:
    taskdep:
      attrs:
        task: run_reformat

metatask_run_prep_plot:
  var:
    VAR: '{{verification.VX_FCST_VAR}}'

  task_run_aggregation_#VAR#:
    <<: *default_task
    command: 'PYTHONPATH=/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/MET-11.1.0:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METplotpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METplotpy/metplotpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METcalcpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METcalcpy/metcalcpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METdataio:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METdataio/METdbLoad/ush /scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/ufs-srweather-app/conda/envs/srw_app/bin/python ${HOMEdir}/parm/vx_plotting/aggregate_ecnt.py'
    join: '&LOGDIR;/aggregation&LOGEXT;'
    dependency:
      taskdep:
        attrs:
          task: run_recombine

  task_run_plot_#VAR#:
    <<: *default_task
    command: 'PYTHONPATH=/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/MET-11.1.0:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METplotpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METplotpy/metplotpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METcalcpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METcalcpy/metcalcpy:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METdataio:/scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/METdataio/METdbLoad/ush /scratch2/BMC/fv3lam/Vanderlei.Vargas/Agile/ufs-srweather-app/conda/envs/srw_app/bin/python ${HOMEdir}/parm/vx_plotting/plot_spread_skill.py'
    join: '&LOGDIR;/plot_&LOGEXT;'
    dependency:
      and: 
        taskvalid:
          attrs:
            task: run_aggregation_#VAR
        taskdep:
          attrs:
            task: run_aggregation_#VAR

